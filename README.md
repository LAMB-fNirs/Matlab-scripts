# Matlab Scripts Readme file

This repo consists of Matlab scripts that can be used for the analyses of the fnirs data.
The flow of using these files is as following

1. DataOrganization Script
2. PreProcFirstLevel Script
3. GroupLevelAnalyses Script
4. DataVisualisation Script

## Data organization Script

Adds stimulus time stamp in the .nirs data file.

## PreProcFirstLevel Script

### **Paths Setup**

- The script adds paths to both the NIRS AnalyzIR toolbox and the data analysis folder using `uigetdir()`, which prompts the user to select directories.
- These paths are required for the analysis functions provided by the toolbox.

### **Loading Data**

- Data is loaded from a specified directory using `nirs.io.loadDirectory()`. Depending on the experiment design, data can be loaded with or without grouping (e.g., by age groups like old/young).

### **Removing Stimulus Marks**

- A loop iterates over each subject's data (`raw(i)`) to remove erroneous stimulus markers generated by programming errors. Specifically, stimulus durations not equal to 0.14 or 0.16 seconds are removed.
- This cleans the data by eliminating unwanted stimulus events.

### **Stimulus Count**

- The script counts the number of stimulus events (trials) for each subject, ensuring that each task has roughly 20 trials per condition.

### **Channel Selection**

- Only specific channels of interest are kept for further analysis. The channels to be removed are specified by `ch_indx`. This reduces the data to the channels relevant to the study's preregistered regions (likely focusing on left hemisphere frontal and temporal areas).

### **HRF Convolution Parameters**

- The onset of stimuli is shifted (`onsetshift`), and the trial duration is set to 4.9 seconds. This aligns stimulus timing for later analyses.

### **Plotting Raw Data (Optional)**

- The script includes the option to plot raw data for inspection.

### **First-Level Processing**

- **Resampling**: Data is downsampled from 50 Hz to 2 Hz to reduce computational complexity.
- **Optical Density Conversion**: Raw fNIRS data is converted to optical density.
- **Modified Beer-Lambert Law**: This law is applied to convert optical density data into hemoglobin concentration changes (HbO and HbR).

### **GLM Analysis**

- A first-level General Linear Model (GLM) is applied using a canonical hemodynamic response function (HRF) with a peak at 6 seconds, based on developmental literature. This step models the relationship between brain activity (HbO/HbR) and task-related stimuli.

### **Adding Demographic Data**

- Participant demographic information (e.g., age, group) is loaded from an Excel file and matched with subject IDs. This data is added to the `SubjStats` structure, which contains the results of the first-level GLM.

### **Saving Intermediate Results**

- The results up to this point (subject-level GLM stats) are saved in the variable `SubjStats`.

### **Extracting Condition-Specific Data**

- For each subject, hemoglobin concentration changes for three different stimulus conditions (`stim_channel1`, `stim_channel2`, `stim_channel3`) are extracted.
- This data is then organized and saved in separate tables for each condition (`Syntax_HbO_Cond1`, `Syntax_HbO_Cond2`, `Syntax_HbO_Cond3`), which are combined into `Syntax_HbO_SubjectBeta`.

### **Saving Final Results**

- The final tables, which contain subject-level beta values (reflecting the strength of the response to each condition), are saved for further analysis.

## GroupLevelAnalyses

### **Adding Paths to Required Toolboxes and Data**

- `uigetdir()` is used to prompt the user to select the directories for the NIRS toolbox and data analysis scripts.
- `addpath(genpath(...))` adds the toolbox and data analysis folder paths to MATLAB’s environment.

### **Group-Level GLM Initialization**

- A **mixed-effects model** is initialized for group-level general linear model (GLM) analysis using `nirs.modules.MixedEffects()`.
- Mixed-effects models allow for both fixed effects (e.g., group or task conditions) and random effects (e.g., differences between individual subjects).

### **Defining and Running GLM Models**

Four models are run:

- **Group x Condition**: Compares different groups (older vs. younger children) across conditions (e.g., correct vs. other task conditions).
    - `grouplevelpipeline.formula = 'beta ~ -1 + group:cond + (1|subject)'`
    - Output: `GroupStats1`
- **Controlling for Task Accuracy**: Adds task accuracy (`synacc`) as a covariate.
    - `grouplevelpipeline.formula = 'beta ~ -1 + group:cond + synacc + (1|subject)'`
    - Output: `GroupStats2`
- **Continuous Task Effects Across Conditions**: Ignores age groups, focusing on overall task condition.
    - `grouplevelpipeline.formula = 'beta ~ -1 + cond + (1|subject)'`
    - Output: `GroupStats3`
- **Controlling for Age**: Adds age in months (`agem`) as a covariate.
    - `grouplevelpipeline.formula = 'beta ~ -1 + cond + agem + (1|subject)'`
    - Output: `GroupStats4`

### **Visualization and Table Output**

- Results for each GLM model (`GroupStats1`, `GroupStats2`, etc.) are visualized using `draw()` with a t-statistic heatmap for values within a set range (e.g., `[-6 6]`).
- The results are converted to tables using the `.table` method, e.g., `Table1 = GroupStats1.table`.
- Results are saved as `.mat` files for later use, e.g., `save('GroupStats_13Jul22.mat','GroupStats3', 'GroupStats4')`.

### **Conditional Contrasts Within Age Groups**

- Contrasts of interest are computed for different tasks and age groups, such as comparing older children’s brain activation in different conditions (e.g., **EDS > ING** or **EDS > Correct**).
- A contrast vector `c` is defined to specify which conditions are compared, e.g., `[0 0 1 0 -1 0 0 0 0]` for **EDS > ING** in older children.
- `groupstats.ttest(c)` runs a t-test for the contrast specified by `c`.
- Results are stored in a table, and the relevant hemoglobin oxygenation results (`hbo`) are extracted using conditions and the `strcmp()` function.

### **Conditional Contrasts Between Age Groups**

- Contrasts between older and younger children are computed for each task condition, e.g., **Older - Younger EDS condition** or **Younger - Older ING condition**.
- Similar to within-group contrasts, t-tests are computed using the defined contrast matrix `c`.

### **Contrasts Across All Participants**

- Contrasts for task conditions (**EDS - ING**, **EDS - Correct**) across all participants (regardless of age) are computed.
- A t-test is performed for each contrast, and the hemoglobin oxygenation (hbo) values are extracted.

### **Saving Results**

- The relevant contrasts (`eds_ing_all_hbo`, `ing_eds_all_hbo`, etc.) are saved to a file (`Syntax_Contrasts_4Aug22.mat`) for further analysis or reporting.

## DataVisualisation

### **Setup and Path Configuration**:

- Adds the paths to the NIRS AnalyzIR toolbox and the data analysis folder that contains the scripts and data necessary for the analysis.
- Adds the path to the 3D plotting package.

### **Data Loading**:

- Loads the group-level statistical data (`GroupStats_Contrasts_9Dec21`), which likely contains contrast or beta values from the GLM analysis.
- Loads the Montreal Neurological Institute (MNI) coordinates for the location of the fNIRS channels in the left hemisphere (LH) from the text files (`MNIcoord_LH.txt` and `MNIcoordstd_LH.txt`).

### **Channel Selection**:

- Optionally, it can remove specific channels based on predefined indices, though this is commented out in the script. This would allow only a subset of channels (e.g., over the frontal and temporal regions) to be analyzed.
- Defines a maximum number of channels (`maxch`) to be plotted and indicates where the channel numbering shifts hemispheres (`hemich`).

### **Condition Definition**:

- Specifies the condition to be plotted (e.g., `older_eds_ing_hbo`), which contains beta and statistical values (e.g., p-values, q-values) for each channel.

### **3D Plot Parameters**:

- Prepares the beta values (intensity) from the condition data to be plotted for each channel.
- Adjusts the MNI coordinates for plotting on both hemispheres by reversing the coordinates for the right hemisphere channels.
- Scales the standard deviation of the coordinates for error representation.

### **Thresholding Based on Statistical Significance**:

- Filters out channels based on p-values (significance level p < 0.05). Channels that do not meet the threshold are excluded from the plot.
- Other options for thresholding (q-values, beta values) are commented out, but they can be used to modify the thresholding method.

### **Coordinate Adjustment for Children**:

- Shifts the MNI coordinates to align with a brain template for children by applying a translation matrix (`shiftmat_child`), which adjusts the brain coordinates.

### **3D Plot Creation**:

- Creates a 3D plot of the brain activity using the filtered data.
- Plots intensity values (beta values) for each channel onto a 3D brain template, using the `Plot3D_channel_registration_result` function. The user is required to manually define the minimum (`minval`) and maximum (`maxval`) values for the intensity scale, which affects the visualization.
